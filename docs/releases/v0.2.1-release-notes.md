# Release v0.2.1 - Bugfix Release

**Release Date:** 2025-01-XX

## Overview

This is a bugfix release that addresses a critical concurrency issue that could cause failures when processing multiple messages concurrently.

## Fixed Issues

### Critical Bugfix: Concurrent Graph Initialization

**Issue:** When processing multiple messages concurrently, the system could raise `RuntimeError: threads can only be started once` due to a race condition in graph initialization.

**Root Cause:** Multiple concurrent calls to `process_message()` could attempt to initialize the graph simultaneously, causing `AsyncSqliteSaver` to try to start the SQLite connection thread multiple times.

**Solution:** Added `asyncio.Lock` to protect graph initialization with a double-check pattern, ensuring thread-safe initialization even under concurrent load.

**Impact:**
- ✅ Fixes concurrent request processing failures
- ✅ Improves thread-safety in RuntimeLoop
- ✅ Enables reliable concurrent message processing

### Build System Fix

**Issue:** The build system could attempt to publish old package versions alongside new ones.

**Solution:** Modified Makefile to clean `dist/` directory before building, ensuring only current version files are published.

## Technical Details

### Changes

- **`src/soni/runtime.py`**: Added `asyncio.Lock` (`_graph_init_lock`) to protect `_ensure_graph_initialized()` method
- **`Makefile`**: Added `rm -rf dist/` before building to prevent publishing old versions

### Testing

All tests pass:
- ✅ 211 passed, 13 skipped
- ✅ Coverage: 85.64% (exceeds 80% target)
- ✅ `test_throughput_concurrent` now passes reliably

## Migration Guide

No migration required. This is a drop-in replacement for v0.2.0.

## Installation

```bash
git clone https://github.com/jmorenobl/soni.git
cd soni
git checkout v0.2.1
uv sync
```

Or install from PyPI (when published):
```bash
uv pip install soni==0.2.1
```

## Full Changelog

See [CHANGELOG.md](../../CHANGELOG.md) for complete details.

## Contributors

Thank you to all contributors who helped identify and fix this issue!
