# Soni Framework v0.4.0 - Zero-Leakage Architecture Release

We're excited to announce the v0.4.0 release of Soni Framework with the new Zero-Leakage Architecture!

## What's New

Soni Framework v0.4.0 introduces a complete Zero-Leakage Architecture where YAML configuration is purely semantic - no technical implementation details leak into configuration files.

### ðŸŽ¯ New Features

- **Zero-Leakage Architecture**: YAML describes WHAT, Python implements HOW
- **Action Registry**: Semantic action registration via `@ActionRegistry.register()`
- **Validator Registry**: Semantic validator registration via `@ValidatorRegistry.register()`
- **Output Mapping**: Decouple technical data structures from flat state variables
- **Auto-Discovery**: Runtime automatically imports actions from config directory

### ðŸ—ï¸ Zero-Leakage Architecture

The Zero-Leakage Architecture ensures that YAML configuration files contain only semantic descriptions, while all technical implementation details live in Python code.

**Before (v0.3.0):**
```yaml
actions:
  search_flights:
    handler: my_handlers.search_flights  # âŒ Python path in YAML
    inputs: [origin, destination]
    outputs: [flights]

slots:
  origin:
    validator: "^[A-Z][a-z]+$"  # âŒ Regex pattern in YAML
```

**After (v0.4.0):**
```yaml
actions:
  search_flights:
    description: "Search for available flights"
    # âœ… No handler path - registered via decorator
    inputs: [origin, destination]
    outputs: [api_flights, api_price]

slots:
  origin:
    validator: city_name  # âœ… Semantic name only

flows:
  book_flight:
    process:
      - step: search
        type: action
        call: search_flights
        map_outputs:
          flights: api_flights  # âœ… Map technical field to flat variable
          price: api_price
```

### ðŸ“ Action Registry

Actions are now registered using decorators in Python code:

```python
from soni.actions.registry import ActionRegistry

@ActionRegistry.register("search_flights")
async def search_flights(origin: str, destination: str) -> dict[str, Any]:
    """Search for available flights."""
    # Implementation here
    return {
        "api_flights": [...],  # Technical field name
        "api_price": 299.99,
    }
```

The runtime automatically discovers and imports actions from:
- `actions.py` in config directory
- `actions/__init__.py` in config directory

### âœ… Validator Registry

Validators are registered using decorators, with regex patterns in Python code:

```python
from soni.validation.registry import ValidatorRegistry
import re

@ValidatorRegistry.register("city_name")
def validate_city(value: str) -> bool:
    """Validate city name format."""
    # Regex lives here, not in YAML
    return bool(re.match(r"^[A-Z][a-z]+$", value))
```

**Built-in Validators:**
- `city_name`: Validates city name format
- `future_date_only`: Validates date is in the future
- `iata_code`: Validates IATA airport code (3 uppercase letters)
- `booking_reference`: Validates booking reference format (6 alphanumeric)

### ðŸ”„ Output Mapping

Output mapping decouples technical data structures from flat state variables:

```yaml
- step: search_flights
  type: action
  call: search_available_flights
  map_outputs:
    flights: api_flights      # state variable <- action output field
    price: api_price
```

The action returns technical structure:
```python
{
    "api_flights": [...],  # Technical field name
    "api_price": 299.99,
    "api_metadata": {...},  # Not mapped - won't appear in state
}
```

After mapping, state contains flat variables:
```python
state.slots = {
    "flights": [...],  # Mapped from api_flights
    "price": 299.99,   # Mapped from api_price
}
```

## Migration from v0.3.0

### Breaking Changes

- **Action Handlers**: Must be registered via `@ActionRegistry.register()` decorator
  - Remove `handler:` fields from YAML action definitions
  - Actions are auto-discovered from `actions.py` or `actions/__init__.py`
- **Validators**: Must be registered via `@ValidatorRegistry.register()` decorator
  - Replace regex patterns in `validator:` fields with semantic validator names
  - Built-in validators available: `city_name`, `future_date_only`, `iata_code`, `booking_reference`
- **Output Mapping**: New optional `map_outputs` field for action steps (backward compatible)

### Upgrade Guide

**1. Migrate Actions:**

```python
# Before (v0.3.0)
# my_handlers.py
async def search_flights(origin: str, destination: str) -> dict:
    return {"flights": [...]}

# YAML
actions:
  search_flights:
    handler: my_handlers.search_flights  # âŒ Remove this
```

```python
# After (v0.4.0)
# actions.py (in config directory)
from soni.actions.registry import ActionRegistry

@ActionRegistry.register("search_flights")
async def search_flights(origin: str, destination: str) -> dict:
    return {"flights": [...]}

# YAML
actions:
  search_flights:
    description: "Search for flights"  # âœ… Semantic only
    inputs: [origin, destination]
    outputs: [flights]
```

**2. Migrate Validators:**

```yaml
# Before (v0.3.0)
slots:
  origin:
    validator: "^[A-Z][a-z]+$"  # âŒ Regex in YAML
```

```python
# After (v0.4.0)
# validators.py (in config directory)
from soni.validation.registry import ValidatorRegistry
import re

@ValidatorRegistry.register("city_name")
def validate_city(value: str) -> bool:
    return bool(re.match(r"^[A-Z][a-z]+$", value))
```

```yaml
# YAML
slots:
  origin:
    validator: city_name  # âœ… Semantic name only
```

**3. Use Output Mapping (Optional):**

```yaml
# Optional: Map technical outputs to flat variables
- step: search
  type: action
  call: search_flights
  map_outputs:
    flights: api_flights
    price: api_price
```

## Getting Started

See our updated documentation:
- [Quickstart Guide](docs/quickstart.md) - Updated with ActionRegistry examples
- [DSL Guide](docs/dsl-guide.md) - Complete syntax including validators and output mapping
- [Architecture Guide](docs/architecture.md) - Zero-Leakage Architecture principles

## Examples

Check out the updated examples:
- [Flight Booking Example](../examples/flight_booking/) - Updated to use ActionRegistry and ValidatorRegistry
- All examples now use semantic configuration only

## Installation

```bash
git clone https://github.com/jmorenobl/soni.git
cd soni
git checkout v0.4.0
uv sync
uv pip install -e .
```

Or install from PyPI (when available):
```bash
pip install soni==0.4.0
```

## Documentation

- [Quickstart Guide](docs/quickstart.md) - Getting started with v0.4.0
- [DSL Guide](docs/dsl-guide.md) - Complete DSL syntax and examples
- [Architecture Guide](docs/architecture.md) - Zero-Leakage Architecture
- [CHANGELOG](../CHANGELOG.md) - Full changelog

## Testing

- 371+ tests passing
- Coverage: 85.89% (target: â‰¥85%)
- Integration tests for ActionRegistry, ValidatorRegistry, and Output Mapping
- Validation that YAML contains no technical details

## Contributors

Thank you to all contributors who made this release possible!

## What's Next

Future releases will focus on:
- Performance optimizations
- Additional built-in validators
- Enhanced error messages
- More examples and tutorials
