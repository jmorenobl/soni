# Soni Banking Domain Configuration
# Version: 1.0

version: "0.1"

settings:
  models:
    nlu:
      provider: openai
      model: gpt-4o-mini
      temperature: 0.1
  persistence:
    backend: sqlite
    path: ./banking_state.db
  logging:
    level: INFO

# ------------------------------------------------------------------
# Flows
# ------------------------------------------------------------------
flows:
  # --- Greeting ---
  greet:
    description: "Greet the user"
    trigger:
      intents:
        - "Hi"
        - "Hello"
        - "Hola"
        - "Good morning"
        - "Hey"
    steps:
      - step: say_hello
        type: action
        call: say_hello
        map_outputs:
          message: message

  # --- Check Balance ---
  check_balance:
    description: "Check how much money you have in your account balance"
    trigger:
      intents:
        - "What is my balance?"
        - "How much money do I have?"
        - "How much do I have?"
        - "Check my checking account"
        - "Balance please"
        - "What's in my account?"
        - "Show me my balance"
        - "and in my {account_type} account?"
        - "and my {account_type}?"
    steps:
      - step: collect_account
        type: collect
        slot: account_type
        prompt: "Which account would you like to check (checking or savings)?"

      - step: get_balance_action
        type: action
        call: get_balance
        map_outputs:
          balance: balance
          currency: currency

      - step: show_balance
        type: action
        call: format_balance_message
        map_outputs:
          message: message

  # --- Transfer Funds ---
  transfer_funds:
    description: "Transfer money to another person"
    trigger:
      intents:
        - "I want to transfer money"
        - "Send funds"
        - "Pay someone"
        - "Transfer"
    steps:
      - step: collect_recipient
        type: collect
        slot: recipient
        prompt: "Who would you like to send money to?"

      - step: collect_amount
        type: collect
        slot: amount
        prompt: "How much would you like to send?"

      - step: collect_currency
        type: collect
        slot: currency
        prompt: "In which currency?"

      - step: collect_source_account
        type: collect
        slot: source_account
        prompt: "From which account?"

      - step: confirm_transfer
        type: confirm
        message: |
          Please confirm the transfer details:
          - To: {recipient}
          - Amount: {amount} {currency}
          - From: {source_account}

          Do you want to proceed?

      - step: execute_transfer
        type: action
        call: execute_transfer
        map_outputs:
          transaction_id: transaction_id
          status: status

  # --- Block Card ---
  block_card:
    description: "Block a lost or stolen card"
    trigger:
      intents:
        - "I lost my card"
        - "Block my card"
        - "Stolen credit card"
    steps:
      - step: collect_card_type
        type: collect
        slot: card_type
        prompt: "Is it a debit or credit card?"

      - step: collect_last_4
        type: collect
        slot: card_last_4
        prompt: "Please provide the last 4 digits of the card."

      - step: confirm_block
        type: confirm
        message: |
          WARNING: This will immediately block your {card_type} card ending in {card_last_4}.
          You will not be able to use it for any new transactions.

          Are you sure you want to block this card?

      - step: execute_block
        type: action
        call: block_card_service
        map_outputs:
          block_reference: block_reference

# ------------------------------------------------------------------
# Slots
# ------------------------------------------------------------------
slots:
  account_type:
    type: string
    prompt: "Which account?"
    validator: account_type
    required: true

  source_account:
    type: string
    prompt: "From which account?"
    validator: account_type
    required: true

  recipient:
    type: string
    prompt: "To whom?"
    required: true
    validator: person_name

  amount:
    type: float
    prompt: "How much?"
    required: true
    validator: positive_amount

  currency:
    type: string
    prompt: "Currency?"
    required: true
    validator: currency_code
    normalization:
        strategy: unknown

  card_type:
    type: string
    prompt: "Card type?"
    validator: card_type
    required: true

  card_last_4:
    type: integer
    prompt: "Last 4 digits?"
    validator: card_digits
    required: true

# ------------------------------------------------------------------
# Actions
# ------------------------------------------------------------------
actions:
  get_balance:
    description: "Get balance for a specific account"
    inputs:
      - account_type
    outputs:
      - balance
      - currency

  format_balance_message:
    description: "Format the balance string"
    inputs:
      - balance
      - currency
      - account_type
    outputs:
      - message

  execute_transfer:
    description: "Execute a fund transfer"
    inputs:
      - source_account
      - recipient
      - amount
      - currency
    outputs:
      - transaction_id
      - status

  block_card_service:
    description: "Block a card"
    inputs:
      - card_type
      - card_last_4
    outputs:
      - block_reference

  say_hello:
    description: "Say hello to the user"
    inputs: []
    outputs:
      - message
